<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Scegli il cap da assegnare</title>
    <link rel="stylesheet" href="../res_lib/suite.css">
    <style>
        div {
            position: fixed;
            top: 1pt;
            left: 0;
            bottom: 0;
            right: 0;
        }
    </style>
    <script src="../res_lib/suite.js" type="text/javascript"></script>
    <script src="../res_scripts/res_global.js" type="text/jscript"></script>
    <script>
        const DataModel = {
            res_country : {
	            ///Nazione constants.
	            logicalName: "res_country",
	            displayName: "Nazione",
	            ///ID organizzazione
	            organizationid: "organizationid",
	            ///Nazione
	            res_countryid: "res_countryid",
	            ///Codice ISO (Apha3)
	            res_isonumber: "res_isonumber",
	            ///Nome
	            res_name: "res_name",
            },
            account : {
	            ///Account constants.
	            logicalName: "account",
	            displayName: "Account",
                ///Indirizzo
                address1_line1: "address1_line1",
                ///CAP
                address1_postalcode: "address1_postalcode",
                ///Città
                address1_city: "address1_city",
                ///Provincia
                address1_stateorprovince: "address1_stateorprovince",
                ///Nazione
                res_countryid: "res_countryid",
	            ///Nazione (Testo)
	            address1_country: "address1_country",
            }
        };
        let form = null;
        //Form model

        onLoad = function () {
            const formconfig = {
                padding: 0,
                rows: [
                    {
                    padding: 0,
                    cols: [
                    {
                        type: "button",
                        name: "cap",
                        text: "SELEZIONA",
                        size: "medium",
                        view: "flat",
                        color: "primary"
                    },
                    {
                        type: "button",
                        name: "reset",
                        text: "ANNULLA",
                        size: "medium",
                        view: "link",
                        color: "primary"
                    }
                    ]
                    }
                ]
            };
            form = new dhx.Form("content", formconfig);
            form.getItem("cap").events.on("click", function () {
                let pageInput = {
                    pageType: "webresource",
                    webresourceName: "/res_pages/getPostalcode.html"
                };
                let navigationOptions = {
                    target: 2,
                    width: { value: 500, unit: "px" },
                    height: { value: 650, unit: "px" },
                    position: 1,
                    title: 'Lista dei C.A.P.'
                };
                window._Xrm.Navigation.navigateTo(pageInput, navigationOptions).then(
                    function success(result) {
                        if (result.returnValue != null) {
                            var entity = getFieldNames(window._formContext._entityName);
                            console.log(entity);
                            //Imposto in automatico i dati presi dal cap
                            let capJson = JSON.parse(result.returnValue);
                            window._formContext.getAttribute(entity.cap).setValue(capJson.code);
                            window._formContext.getAttribute(entity.city).setValue(capJson.city);
                            window._formContext.getAttribute(entity.province).setValue(capJson.province);
                            window._formContext.getAttribute(entity.nation).setValue(capJson.country);
                            window._formContext.getAttribute(entity.country).setValue([{ id: capJson.countryid, entityType: DataModel.res_country.logicalName, name: capJson.country }]);
                        }

                        //Aggiorno in automatico i campi dell'indirizzo
                        window._form.onChangeAddress(window._context);
                    },
                    function error(error) {
                        console.log(error.message)
                    }
                );
            });
            form.getItem("reset").events.on("click", function () {

                var entity = getFieldNames(window._formContext._entityName);
                console.log(entity);
                //Annullo i valori
                window._formContext.getAttribute(entity.cap).setValue(null);
                window._formContext.getAttribute(entity.city).setValue(null);
                window._formContext.getAttribute(entity.province).setValue(null);
                window._formContext.getAttribute(entity.nation).setValue(null);
                window._formContext.getAttribute(entity.country).setValue(null);

                //Aggiorno in automatico i campi dell'indirizzo
                window._form.onChangeAddress(window._context);

            });

            if (window._Xrm == undefined && parent._Xrm != undefined) {
                setContext(parent._Xrm, parent._formContext);
            }

        };
        setContext = function (_xrm, _formContext, _form, _context) {
            window._Xrm = _xrm;
            window._formContext = _formContext;
            window._form = _form;
            window._context = _context;
            parent._Xrm = _xrm;
            parent._formContext = _formContext;
            parent._form = _form;
            parent._context = _context;
        }
        getFieldNames = function (entityName) {

            var entityFields = {
                cap: "",
                city: "",
                province: "",
                nation: "",
                country: ""
            }

            switch (entityName) {
                case "quote":
                    entityFields.cap = "shipto_postalcode";
                    entityFields.city = "shipto_city";
                    entityFields.province = "shipto_stateorprovince";
                    entityFields.nation = "shipto_country";
                    entityFields.country = "res_countryid";
                    break;
                case "salesorder":
                    entityFields.cap = "shipto_postalcode";
                    entityFields.city = "shipto_city";
                    entityFields.province = "shipto_stateorprovince";
                    entityFields.nation = "shipto_country";
                    entityFields.country = "res_countryid";
                    break;
                default:
                    entityFields.cap = "address1_postalcode";
                    entityFields.city = "address1_city";
                    entityFields.province = "address1_stateorprovince";
                    entityFields.nation = "address1_country";
                    entityFields.country = "res_countryid";
                    break;

            }
            return entityFields;
        }
    </script>
</head>
<body onload="onLoad()">
    <div id="content"></div>
</body>
</html>